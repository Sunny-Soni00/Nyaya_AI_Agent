<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nyaya-Sahayak | Courtroom</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a1a;
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: #2d2d2d;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #3a3a3a;
        }

        .logo {
            font-size: 20px;
            font-weight: 600;
            color: #4a90e2;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4caf50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Video Section */
        .video-section {
            flex: 2;
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 20px;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            flex: 1;
        }

        .video-box {
            background: #2d2d2d;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #3a3a3a;
        }

        .video-box.active {
            border-color: #4a90e2;
        }

        .video-placeholder {
            text-align: center;
        }

        .video-placeholder svg {
            width: 80px;
            height: 80px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .participant-name {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        /* Controls */
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 20px;
        }

        .control-btn {
            background: #3a3a3a;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: #4a4a4a;
            transform: scale(1.05);
        }

        .control-btn.active {
            background: #4a90e2;
        }

        .control-btn.danger {
            background: #e74c3c;
        }

        .control-btn svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        /* Transcript Panel */
        .transcript-panel {
            flex: 1;
            background: #2d2d2d;
            border-left: 1px solid #3a3a3a;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 20px;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            gap: 10px;
        }

        .tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .tab.active {
            background: #3a3a3a;
            color: #fff;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .transcript-item {
            margin-bottom: 20px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .transcript-time {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }

        .transcript-text {
            background: #3a3a3a;
            padding: 12px;
            border-radius: 8px;
            line-height: 1.6;
        }

        .interim-text {
            color: #888;
            font-style: italic;
            padding: 8px;
            border-left: 2px solid #4a90e2;
            margin-left: 12px;
        }

        /* Chat Section */
        .chat-section {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .chat-section.active {
            display: flex;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .chat-message {
            margin-bottom: 15px;
        }

        .chat-message.user {
            text-align: right;
        }

        .chat-bubble {
            display: inline-block;
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 5px;
        }

        .chat-message.user .chat-bubble {
            background: #4a90e2;
            text-align: left;
        }

        .chat-message.assistant .chat-bubble {
            background: #3a3a3a;
        }

        .chat-input-container {
            padding: 20px;
            border-top: 1px solid #3a3a3a;
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            background: #3a3a3a;
            border: 1px solid #4a4a4a;
            border-radius: 8px;
            padding: 12px 16px;
            color: #fff;
            font-size: 14px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .send-btn {
            background: #4a90e2;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .send-btn:hover {
            background: #357abd;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #2d2d2d;
        }

        ::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #5a5a5a;
        }

        .clear-btn {
            background: #e74c3c;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            color: white;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">‚öñÔ∏è Nyaya-Sahayak</div>
            <div class="status">
                <span class="status-dot"></span>
                <span id="status-text">Ready</span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Video Section -->
            <div class="video-section">
                <div class="video-grid">
                    <div class="video-box active">
                        <div class="video-placeholder">
                            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                            <div>Judge</div>
                        </div>
                        <div class="participant-name">Judge Sharma</div>
                    </div>
                    <div class="video-box">
                        <div class="video-placeholder">
                            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                            <div>Plaintiff Lawyer</div>
                        </div>
                        <div class="participant-name">Adv. Priya Mehta</div>
                    </div>
                    <div class="video-box">
                        <div class="video-placeholder">
                            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                            <div>Defense Lawyer</div>
                        </div>
                        <div class="participant-name">Adv. Rajesh Kumar</div>
                    </div>
                    <div class="video-box">
                        <div class="video-placeholder">
                            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                            <div>Court Clerk</div>
                        </div>
                        <div class="participant-name">Clerk Singh</div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="controls">
                    <button class="control-btn" id="micBtn" title="Toggle Microphone">
                        <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                    </button>
                    <button class="control-btn" id="videoBtn" title="Toggle Video">
                        <svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>
                    </button>
                    <button class="control-btn danger" id="endBtn" title="End Session">
                        <svg viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.68-1.36-2.66-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg>
                    </button>
                </div>
            </div>

            <!-- Transcript Panel -->
            <div class="transcript-panel">
                <div class="panel-header">
                    <h2>Session Details</h2>
                    <div class="tabs">
                        <button class="tab active" data-tab="transcript">Transcript</button>
                        <button class="tab" data-tab="evidence">Evidence</button>
                        <button class="tab" data-tab="chat">AI Assistant</button>
                    </div>
                </div>
                <div class="panel-content">
                    <div id="transcript-view" class="transcript-view">
                        <div style="text-align: center; color: #888; padding: 40px 20px;">
                            <p>Click the microphone button to start recording</p>
                            <p style="font-size: 12px; margin-top: 10px;">Real-time transcription will appear here</p>
                        </div>
                        <div id="interimText" class="interim-text" style="display: none;"></div>
                    </div>
                    
                    <div id="evidence-view" class="chat-section">
                        <div style="padding: 20px;">
                            <h3 style="margin-bottom: 15px;">üìÅ Evidence Upload</h3>
                            <p style="color: #888; font-size: 14px; margin-bottom: 20px;">
                                Upload PDFs, images, or audio files. Audio will be transcribed automatically. The AI will use this context when answering questions.
                            </p>
                            
                            <div style="background: #3a3a3a; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                <input type="file" id="evidenceFiles" multiple 
                                       accept=".pdf,.jpg,.jpeg,.png,.bmp,.tiff,.mp3,.wav,.m4a,.ogg,.webm" 
                                       style="display: block; margin-bottom: 15px; color: #fff;">
                                <button id="uploadBtn" style="background: #4a90e2; border: none; padding: 10px 20px; 
                                        border-radius: 6px; color: white; cursor: pointer; font-weight: 500;">
                                    Upload Evidence
                                </button>
                                <div id="uploadStatus" style="margin-top: 10px; font-size: 14px;"></div>
                            </div>
                            
                            <h4 style="margin-bottom: 10px;">Uploaded Files:</h4>
                            <div id="evidenceList" style="background: #2d2d2d; padding: 15px; border-radius: 8px; 
                                    min-height: 100px; max-height: 300px; overflow-y: auto;">
                                <p style="color: #888; text-align: center;">No evidence uploaded yet</p>
                            </div>
                            
                            <button id="clearEvidenceBtn" style="background: #e74c3c; border: none; padding: 8px 16px; 
                                    border-radius: 6px; color: white; cursor: pointer; margin-top: 15px;">
                                Clear All Evidence
                            </button>
                        </div>
                    </div>
                    
                    <div id="chat-view" class="chat-section">
                        <div class="chat-messages" id="chatMessages">
                            <div style="text-align: center; color: #888; padding: 20px;">
                                <p>üí¨ Ask questions about the transcript and evidence</p>
                                <p style="font-size: 12px; margin-top: 10px;">
                                    The AI has access to both the live transcript and uploaded evidence files
                                </p>
                            </div>
                        </div>
                        <div class="chat-input-container">
                            <input type="text" class="chat-input" id="chatInput" placeholder="Ask about the session or evidence...">
                            <button class="send-btn" id="sendBtn">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isRecording = false;
        let transcribeWs = null;
        let chatWs = null;
        let mediaRecorder = null;
        let audioContext = null;

        const statusText = document.getElementById('status-text');
        const micBtn = document.getElementById('micBtn');
        const transcriptView = document.getElementById('transcript-view');
        const interimTextDiv = document.getElementById('interimText');
        const chatView = document.getElementById('chat-view');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');

        // Tab switching
        const evidenceView = document.getElementById('evidence-view');
        const uploadBtn = document.getElementById('uploadBtn');
        const evidenceFilesInput = document.getElementById('evidenceFiles');
        const uploadStatus = document.getElementById('uploadStatus');
        const evidenceList = document.getElementById('evidenceList');
        const clearEvidenceBtn = document.getElementById('clearEvidenceBtn');

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                if (tab.dataset.tab === 'transcript') {
                    transcriptView.style.display = 'block';
                    evidenceView.classList.remove('active');
                    chatView.classList.remove('active');
                } else if (tab.dataset.tab === 'evidence') {
                    transcriptView.style.display = 'none';
                    evidenceView.classList.add('active');
                    chatView.classList.remove('active');
                    loadEvidenceList();
                } else {
                    transcriptView.style.display = 'none';
                    evidenceView.classList.remove('active');
                    chatView.classList.add('active');
                }
            });
        });

        // Microphone toggle
        micBtn.addEventListener('click', async () => {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        });

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Create WebSocket connection
                transcribeWs = new WebSocket('ws://localhost:8000/ws/transcribe');
                
                let voiceDetectionTimer = null;
                
                transcribeWs.onopen = () => {
                    console.log('Connected to transcription service');
                    statusText.textContent = 'Recording... (Speak now)';
                    statusText.style.color = '#4a90e2';
                    micBtn.classList.add('active');
                    isRecording = true;
                    
                    // Set a timer to warn if no voice detected after 10 seconds
                    voiceDetectionTimer = setTimeout(() => {
                        if (isRecording && transcriptView.querySelectorAll('.transcript-item').length === 0) {
                            statusText.textContent = '‚ö†Ô∏è No voice detected - Please speak';
                            statusText.style.color = '#e74c3c';
                        }
                    }, 10000);
                };

                transcribeWs.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'transcript') {
                        addTranscript(data.data);
                        interimTextDiv.style.display = 'none';
                    } else if (data.type === 'interim') {
                        interimTextDiv.textContent = data.data.text;
                        interimTextDiv.style.display = 'block';
                    } else if (data.type === 'warning') {
                        // Show warning notification
                        alert('‚ö†Ô∏è ' + data.message);
                        statusText.textContent = 'No voice detected';
                        statusText.style.color = '#e74c3c';
                        setTimeout(() => {
                            if (isRecording) {
                                statusText.textContent = 'Recording...';
                                statusText.style.color = '';
                            }
                        }, 3000);
                    }
                };

                transcribeWs.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    statusText.textContent = 'Connection error';
                };

                transcribeWs.onclose = () => {
                    console.log('Transcription WebSocket closed');
                    if (isRecording) {
                        statusText.textContent = 'Connection closed';
                        alert('‚ö†Ô∏è Transcription connection closed. Click the microphone to restart.');
                        stopRecording();
                    }
                };

                // Setup MediaRecorder to send audio data - optimized buffer size
                audioContext = new AudioContext({ sampleRate: 16000 });
                const source = audioContext.createMediaStreamSource(stream);
                const processor = audioContext.createScriptProcessor(2048, 1, 1);  // Smaller buffer = faster processing

                source.connect(processor);
                processor.connect(audioContext.destination);

                processor.onaudioprocess = (e) => {
                    if (transcribeWs && transcribeWs.readyState === WebSocket.OPEN) {
                        const inputData = e.inputBuffer.getChannelData(0);
                        const pcmData = convertFloat32ToInt16(inputData);
                        transcribeWs.send(pcmData);
                    }
                };

            } catch (error) {
                console.error('Error starting recording:', error);
                alert('Could not access microphone. Please check permissions.');
            }
        }

        function stopRecording() {
            if (transcribeWs) {
                transcribeWs.close();
            }
            if (audioContext) {
                audioContext.close();
            }
            
            isRecording = false;
            micBtn.classList.remove('active');
            statusText.textContent = 'Ready';
            statusText.style.color = '';
            
            // Clear voice detection timer
            if (voiceDetectionTimer) {
                clearTimeout(voiceDetectionTimer);
                voiceDetectionTimer = null;
            }
        }

        function convertFloat32ToInt16(buffer) {
            const l = buffer.length;
            const buf = new Int16Array(l);
            for (let i = 0; i < l; i++) {
                buf[i] = Math.min(1, buffer[i]) * 0x7FFF;
            }
            return buf.buffer;
        }

        function addTranscript(data) {
            const item = document.createElement('div');
            item.className = 'transcript-item';
            
            const time = new Date(data.timestamp).toLocaleTimeString();
            
            item.innerHTML = `
                <div class="transcript-time">${time} - ${data.speaker}</div>
                <div class="transcript-text">${data.text}</div>
            `;
            
            // Remove placeholder text if present
            const placeholder = transcriptView.querySelector('[style*="text-align: center"]');
            if (placeholder) {
                placeholder.remove();
            }
            
            transcriptView.insertBefore(item, interimTextDiv);
            transcriptView.scrollTop = transcriptView.scrollHeight;
            
            // Clear voice detection timer on first transcript
            if (voiceDetectionTimer) {
                clearTimeout(voiceDetectionTimer);
                voiceDetectionTimer = null;
            }
            
            // Update status to show transcription is working
            if (isRecording) {
                statusText.textContent = 'Recording... ‚úì';
                statusText.style.color = '#27ae60';
            }
        }

        // Chat functionality
        sendBtn.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChatMessage();
        });

        function sendChatMessage() {
            const question = chatInput.value.trim();
            if (!question) return;

            addChatMessage(question, 'user');
            chatInput.value = '';

            // Connect to chat WebSocket if not connected
            if (!chatWs || chatWs.readyState !== WebSocket.OPEN) {
                chatWs = new WebSocket('ws://localhost:8000/ws/chat');
                
                chatWs.onopen = () => {
                    chatWs.send(JSON.stringify({ question }));
                };

                chatWs.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.type === 'answer') {
                        addChatMessage(data.data.answer, 'assistant');
                    }
                };
            } else {
                chatWs.send(JSON.stringify({ question }));
            }
        }

        function addChatMessage(text, sender) {
            const msg = document.createElement('div');
            msg.className = `chat-message ${sender}`;
            msg.innerHTML = `<div class="chat-bubble">${text}</div>`;
            
            // Remove placeholder if present
            const placeholder = chatMessages.querySelector('[style*="text-align: center"]');
            if (placeholder) {
                placeholder.remove();
            }
            
            chatMessages.appendChild(msg);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Evidence upload functionality
        uploadBtn.addEventListener('click', async () => {
            const files = evidenceFilesInput.files;
            if (files.length === 0) {
                uploadStatus.innerHTML = '<span style="color: #e74c3c;">Please select files to upload</span>';
                return;
            }

            const formData = new FormData();
            for (let file of files) {
                formData.append('files', file);
            }

            uploadStatus.innerHTML = '<span style="color: #4a90e2;">Uploading...</span>';
            uploadBtn.disabled = true;

            try {
                const response = await fetch('http://localhost:8000/upload-evidence', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (response.ok) {
                    const numFiles = result.files ? result.files.length : 0;
                    uploadStatus.innerHTML = `<span style="color: #27ae60;">‚úì Successfully uploaded ${numFiles} file(s)</span>`;
                    evidenceFilesInput.value = '';
                    setTimeout(() => loadEvidenceList(), 200);
                } else {
                    uploadStatus.innerHTML = `<span style="color: #e74c3c;">Error: ${result.error || result.detail || 'Upload failed'}</span>`;
                }
            } catch (error) {
                uploadStatus.innerHTML = `<span style="color: #e74c3c;">Upload failed: ${error.message}</span>`;
                console.error('Upload error:', error);
            } finally {
                uploadBtn.disabled = false;
            }
        });

        async function loadEvidenceList() {
            try {
                const response = await fetch('http://localhost:8000/evidence');
                const data = await response.json();
                
                if (data.files && data.files.length > 0) {
                    evidenceList.innerHTML = data.files.map(fileInfo => {
                        const filename = typeof fileInfo === 'string' ? fileInfo : fileInfo.filename;
                        const fileType = typeof fileInfo === 'object' ? fileInfo.type : 'document';
                        const hasTranscript = typeof fileInfo === 'object' ? fileInfo.has_transcript : false;
                        
                        let icon = 'üìÑ';
                        let typeLabel = 'Document';
                        
                        if (fileType === 'audio') {
                            icon = 'üéµ';
                            typeLabel = 'Audio File';
                        } else if (filename.endsWith('.pdf')) {
                            icon = 'üìÑ';
                            typeLabel = 'PDF Document';
                        } else {
                            icon = 'üñºÔ∏è';
                            typeLabel = 'Image File';
                        }
                        
                        return `
                            <div style="padding: 10px; border-bottom: 1px solid #3a3a3a; display: flex; 
                                    align-items: center; gap: 10px;">
                                <span style="font-size: 20px;">${icon}</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500;">${filename}</div>
                                    <div style="font-size: 12px; color: #888;">
                                        ${typeLabel}
                                    </div>
                                </div>
                                ${hasTranscript ? `
                                    <button onclick="viewTranscript('${filename}')" 
                                        style="background: #27ae60; border: none; padding: 6px 12px; 
                                        border-radius: 4px; color: white; cursor: pointer; font-size: 12px; margin-right: 5px;">
                                        üìù View Transcript
                                    </button>
                                ` : ''}
                                <button onclick="deleteEvidence('${filename}')" 
                                    style="background: #e74c3c; border: none; padding: 6px 12px; 
                                    border-radius: 4px; color: white; cursor: pointer; font-size: 12px;">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        `;
                    }).join('');
                } else {
                    evidenceList.innerHTML = '<p style="color: #888; text-align: center;">No evidence uploaded yet</p>';
                }
            } catch (error) {
                evidenceList.innerHTML = '<p style="color: #e74c3c; text-align: center;">Failed to load evidence list</p>';
                console.error('Load evidence error:', error);
            }
        }
        
        async function viewTranscript(filename) {
            try {
                const response = await fetch(`http://localhost:8000/evidence/transcript/${encodeURIComponent(filename)}`);
                const data = await response.json();
                
                if (response.ok) {
                    // Create modal to show transcript
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                        background: rgba(0,0,0,0.8); z-index: 1000;
                        display: flex; align-items: center; justify-content: center;
                        padding: 20px;
                    `;
                    
                    modal.innerHTML = `
                        <div style="background: #2d2d2d; border-radius: 12px; max-width: 800px; 
                                max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
                            <div style="padding: 20px; border-bottom: 1px solid #3a3a3a; display: flex; 
                                    justify-content: space-between; align-items: center;">
                                <h3 style="margin: 0;">üéµ Audio Transcript: ${filename}</h3>
                                <button onclick="this.closest('div[style*=fixed]').remove()" 
                                    style="background: #e74c3c; border: none; padding: 8px 16px; 
                                    border-radius: 6px; color: white; cursor: pointer;">
                                    Close
                                </button>
                            </div>
                            <div style="padding: 20px; overflow-y: auto; flex: 1;">
                                <p style="white-space: pre-wrap; line-height: 1.6; color: #e0e0e0;">
                                    ${data.transcript}
                                </p>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                } else {
                    alert('‚ùå Failed to load transcript');
                }
            } catch (error) {
                alert('‚ùå Error loading transcript: ' + error.message);
            }
        }

        async function deleteEvidence(filename) {
            if (!confirm(`Delete ${filename}?`)) {
                return;
            }

            try {
                const response = await fetch(`http://localhost:8000/evidence/${encodeURIComponent(filename)}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (response.ok) {
                    uploadStatus.innerHTML = `<span style="color: #27ae60;">‚úì Deleted ${filename}</span>`;
                    loadEvidenceList();
                } else {
                    uploadStatus.innerHTML = `<span style="color: #e74c3c;">Error: ${result.error || 'Delete failed'}</span>`;
                }
            } catch (error) {
                uploadStatus.innerHTML = `<span style="color: #e74c3c;">Failed to delete file</span>`;
                console.error('Delete error:', error);
            }
        }

        clearEvidenceBtn.addEventListener('click', async () => {
            if (!confirm('Are you sure you want to clear all evidence files?')) {
                return;
            }

            try {
                const response = await fetch('http://localhost:8000/clear-evidence', {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (response.ok) {
                    uploadStatus.innerHTML = '<span style="color: #27ae60;">‚úì All evidence cleared</span>';
                    loadEvidenceList();
                } else {
                    uploadStatus.innerHTML = `<span style="color: #e74c3c;">Error: ${result.detail}</span>`;
                }
            } catch (error) {
                uploadStatus.innerHTML = `<span style="color: #e74c3c;">Failed to clear evidence</span>`;
            }
        });
    </script>
</body>
</html>